# مشخصات فنی جستجو و فیلترهای FindAPhD (ربات‌پسند)

این سند تمام روش‌های جستجو و فیلترهای قابل مشاهده در FindAPhD را به‌صورت عملیاتی مستند می‌کند تا بتوانید «ربات جستجو» بسازید که همه فیلترها را شناسایی و اعمال کند.

منبع بررسی: صفحات عمومی FindAPhD در تاریخ 2025-09-11 (بدون لاگین). نمونه‌ها از لینک پایه:
- https://www.findaphd.com/phds/
- نمونه‌های کلیدی: `Keywords`٬ دسته/رشته (Discipline/Subject)٬ موقعیت (Country/Region)٬ نوع تامین مالی/دانشجو٬ صفحه‌بندی (PG)

> نکته: بسیاری از فیلترها به‌صورت «توکن کُدیِ بی‌نام» در QueryString می‌آیند (بدون اسم پارامتر، فقط مقدار). این‌ها خانواده‌هایی با پیشوندهای قابل تشخیص دارند و می‌توانند با `&` ترکیب شوند. به‌همین دلیل، «کشف (Discovery)» کُدها از خود لینک‌های سایت برای ربات ضروری است.

---

## نمای کلی

- دو الگوی اصلی جستجو:
  1) جستجوی کلیدواژه: `?Keywords=<کلمات-کلیدی-URL-Encode>`
  2) جستجوی طبقه‌بندی‌شده: با اسلاگ مسیر (مثلاً `phds/computer-science/`) به‌علاوه یک «توکن کُدِ رشته/موضوع» در QueryString.
- فیلترها با هم قابل ترکیب‌اند: کافی است «توکن‌های کُدیِ فیلترهای مختلف» را با `&` پشت سر هم بیاورید و در صورت نیاز `Keywords` و `PG` را هم اضافه کنید.
- صفحه‌بندی با `PG=<شماره-صفحه>`.

### کاتالوگ خانوادهٔ فیلترها (قطعی/تأییدشده)

- Keywords (کلیدواژه): پارامتر نام‌دار `Keywords`
- Pagination (صفحه‌بندی): پارامتر نام‌دار `PG`
- Discipline (رشته): توکن بی‌نام با پیشوند `^10`
- Subject (زیررشته): توکن بی‌نام با پیشوند `^30`
- Geo (کشور/منطقه): توکن بی‌نام با پیشوند `^g`
- Funding/Eligibility (تأمین مالی/واجد بودن): توکن بی‌نام با پیشوند `^01`

### کاتالوگ خانوادهٔ فیلترها (مورد انتظار/نیازمند کشف پویا)

- Institution (موسسه/دانشگاه): توکن اختصاصی (هنوز استخراج نشده از HTML ایستا)
- PhD Type (نوع برنامه/Project vs Programme و ...): توکن اختصاصی (هنوز استخراج نشده)
- Study Mode (تمام‌وقت/پاره‌وقت/دورکاری): توکن اختصاصی (هنوز استخراج نشده)
- Sort / Latest-only (مرتب‌سازی/فقط جدیدها): پارامتر نام‌دار یا توکن (نیازمند تحلیل JS)

---

## ساختار URL و پارامترها

- پایه فهرست‌ها: `https://www.findaphd.com/phds/`
- کلیدواژه:
  - `?Keywords=machine%20learning`
  - مثال: `https://www.findaphd.com/phds/?Keywords=machine%20learning`
- صفحه‌بندی:
  - `PG=2` (مثلاً صفحه ۲)
  - مثال: `https://www.findaphd.com/phds/?Keywords=machine%20learning&PG=2`
- رشته (Discipline) و زیررشته/موضوع (Subject):
  - الگوی لینک‌ها: مسیر + توکن کُدی بی‌نام در QueryString
  - مثال رشته: `https://www.findaphd.com/phds/computer-science/?10M7g0`
  - مثال زیررشته داخل Computer Science (مانند AI): `https://www.findaphd.com/phds/artificial-intelligence/?30M7g2t1`
- موقعیت (Location: کشور/شهر-منطقه):
  - کشور به‌صورت مسیر + کد مکان در QueryString
  - مثال: UK → `https://www.findaphd.com/phds/united-kingdom/?g0w900`
- نوع/وضعیت تامین مالی/جنس دانشجو (Funding/Eligibility):
  - مثال‌ها از لینک‌های رسمی:
    - UK student: `?0100` (مثال ترکیبی: `https://www.findaphd.com/phds/uk-students/?0100` یا همراه کلیدواژه: `?0100&Keywords=...`)
    - Self-funded: `?01M0`
    - Non-EU student: `?01w0`
    - EU (exc UK): `?01g0`
- ترکیب فیلترها (AND):
  - کافی است توکن‌ها را با `&` کنار هم بگذارید.
  - مثال: Computer Science + UK → مسیر ترکیبی یا تک‌مسیره، هر دو معتبر:
    - `https://www.findaphd.com/phds/computer-science/united-kingdom/?10M7g0&g0w900`
    - یا: `https://www.findaphd.com/phds/computer-science/?10M7g0&g0w900`

---

## خانوادهٔ توکن‌های بی‌نام (Observation-based)

این توکن‌ها «اسم پارامتر» ندارند و با پیشوندشان می‌توان خانواده‌شان را حدس زد:

- رشته (Discipline) – نمونه پیشوند: `10...`
  - مثال: `10M7g0` برای Computer Science (از لینک‌های خود سایت)
- زیررشته/موضوع (Subject) – نمونه پیشوند: `30...`
  - مثال: `30M7g2t1` برای Artificial Intelligence (زیر مجموعه Computer Science)
- موقعیت جغرافیایی (Geo) – نمونه پیشوند: `g...`
  - مثال‌ها: `g0w900` (United Kingdom)، `g0Mw00` (Germany)، `g0w000` (Canada)
- تامین مالی/نوع دانشجو (Funding/Eligibility) – نمونه پیشوند: `01...`
  - مثال‌ها: `0100` (UK student)، `01M0` (Self-funded)، `01w0` (Non‑EU)، `01g0` (EU excl. UK)

نکته‌ها:
- این کدها «opaque» هستند؛ بنابراین برای پوشش کامل باید «واژه‌نامهٔ کدها» را با خزش اولیه از خود سایت بسازید (بخش «کشف کدها» را ببینید).
- توکن‌ها قابل جمع‌شدن هستند (AND). نبود توکن یعنی «All» برای آن خانواده.

زیرگروه‌های Funding/Eligibility تأییدشده از UI:
- UK students → `0100`
- Self-funded → `01M0`
- Non‑EU students → `01w0`
- EU students (exc UK) → `01g0`

---

## فیلترهای UI قابل مشاهده و معادل URL

- Discipline (رشته) و Subject (زیررشته): از منوهای «Discipline / Subject» → لینک‌ها شامل اسلاگ + توکن (`10...` یا `30...`).
- Location (کشور/منطقه): از منوی «Location» → لینک کشورها شامل اسلاگ مکان + توکن `g...`.
- Institution (دانشگاه/موسسه): در UI وجود دارد. لینک‌های مستقیم «Browse by institution» به صفحات ASPX می‌روند، اما در خود جستجو نیز فیلتر موسسه وجود دارد که معمولاً با «توکن اختصاصی» اعمال می‌شود. چون توکن‌های Institution در نمونه‌های عمومی دیده نشد، برای ربات باید از «کشف کدها» استفاده کنید (بخش بعدی).
- PhD Type (نوع برنامه: PhD/Programme/Project و ...): در UI وجود دارد؛ کدهای دقیق آن از لینک‌های داخلی قابل کشف است (بخش «کشف کدها»).
- Funding (نوع تامین مالی/واجد شرایط بودن): گزینه‌های رایج و کدهایشان در بالا آمده.
- Latest PhDs only (فقط جدیدها): در صفحات نتایج کلید/چک‌باکس «Latest PhDs only» دیده می‌شود، اما نام پارامتر آن در HTML ثابت قابل مشاهده نبود. پیشنهاد: با فعال‌سازی UI (Session واقعی) پارامتر را ضبط کنید یا از «مرتب‌سازی بر اساس تاریخ» اگر موجود باشد استفاده کنید. تا زمان کشف قطعی، این مورد را «تحت کشف» نگه دارید.
- Sort (مرتب‌سازی): پارامتر صریح در نمونه‌های استاتیک مشاهده نشد. معمولاً سایت‌ها `SortBy` یا مشابه دارند. نیازمند کشف پویا.

نکتهٔ تجربی: برخی اسلاگ‌ها مانند `fully-funded/`, `competition-funded/`, `distance-learning/`, `part-time/` در حال حاضر به صفحهٔ 404 هدایت می‌شوند (بنابراین روی «توکن‌های بی‌نام» تمرکز کنید و کشف را از خود لینک‌های ارائه‌شده در پنل فیلتر انجام دهید).

---

## صفحه‌بندی

- پارامتر `PG=<n>`
- مثال‌ها (از لینک‌های خود سایت):
  - `.../phds/computer-science/?10M7g0&PG=2`
  - در برخی صفحات ترکیبی، لینک صفحه‌بندی ممکن است به مسیر رشته بازنویسی شود اما پارامتر صفحه (`PG`) پایدار است.

---

## ترکیب‌ها و الگوهای رایج (Examples)

- کلیدواژه + فاندینگ (Self-funded):
  - `https://www.findaphd.com/phds/?Keywords=machine%20learning&01M0`
- رشته + کشور + صفحه ۳:
  - `https://www.findaphd.com/phds/computer-science/united-kingdom/?10M7g0&g0w900&PG=3`
- زیررشته (AI) + کشور (Germany):
  - `https://www.findaphd.com/phds/artificial-intelligence/germany/?30M7g2t1&g0Mw00`

> نکته: وجود اسلاگ‌ها در مسیر بیشتر برای خوانایی و SEO است؛ «مبنای اعمال فیلتر» همان توکن‌های QueryString هستند. در اکثر موارد حتی اگر اسلاگ مسیر هم‌خوان نباشد، توکن‌ها تعیین‌کنندهٔ نتیجه‌اند؛ بااین‌حال بهتر است مسیر را هم منطبق بسازید.

---

## کشف کُدها (Discovery) برای پوشش کامل

برای اینکه ربات شما همه فیلترها را «شناخته» و بتواند تولید/تجزیه کند، این مراحل را اجرا کنید:

1) نقطه شروع
   - صفحهٔ پایه: `https://www.findaphd.com/phds/`
   - در هدر/فوتر/بخش‌های «PhDs by Subject / by Country» لینک‌های بسیاری وجود دارد.

2) خزش لینک‌ها و ساخت واژه‌نامه‌ها
   - Discipline/Subject:
     - همه لینک‌های `https://www.findaphd.com/phds/<slug>/?<token>` که `<token>` با `10` یا `30` شروع می‌شود را جمع کنید.
     - نگاشت: `{ token -> {type: 'discipline'|'subject', name, slug} }` بسازید.
   - Location:
     - از بخش «PhDs by country» همه لینک‌ها با `?g...` را جمع کنید.
     - نگاشت: `{ token -> {type: 'geo', level: 'country'|'region'?, name, slug} }`.
   - Funding/Eligibility:
     - از منوی Funding لینک‌هایی که به `/uk-students/`, `/self-funded/`, `/eu-students/`, `/non-eu-students/` می‌روند و دارای `?01..` هستند را جمع کنید.
     - نگاشت: `{ token -> {type: 'funding/eligibility', label} }`.
   - Institution و PhD Type:
     - منوی «Institution» و «PhD Type» را باز کنید (ممکن است با جاوااسکریپت رندر شود). لینک‌های «نمایش نتایج» معمولاً URLهایی با «توکن» می‌سازند. همان الگو را استخراج کنید.
     - توصیهٔ فنی: با یک مرورگر headless (Puppeteer/Playwright) رویداد کلیک روی هر گزینه را اجرا و `href` یا تغییر URL را شنود کنید؛ هر توکن بی‌نام جدید را در واژه‌نامه ذخیره کنید.
   - Study Mode (Part‑time/Full‑time/Distance):
     - در صورت وجود در پنل فیلتر، همین روش بالا را تکرار کنید. اگر گزینه فقط «چک‌باکس» است، پارامتر نام‌دار را از تغییر URL استخراج کنید (ممکن است به صورت `Mode=...` یا توکن بی‌نام باشد).

3) قوانین ترکیب
   - در یک URL، صفر یا یک توکن از هر خانواده «ضروری» نیست، ولی وجود بیش از یک توکن از یک خانواده معمولاً به معنی چندانتخابی در همان خانواده است (اگر UI اجازه دهد). ابتدا یک‌به‌یک تست کنید.
   - برای اجتناب از برخورد، ترتیب توکن‌ها مهم نیست؛ هر کدام با `&` جدا شوند.

4) تشخیص فیلترهای فعال از URL
   - پارامترهای نام‌دار را مستقیم بخوانید: `Keywords`, `PG`.
   - توکن‌های بی‌نام را با پیشوندشان دسته‌بندی کنید (Regex ساده):
     - `^10` → Discipline
     - `^30` → Subject
     - `^g`  → Geo
     - `^01` → Funding/Eligibility
     - سایر پیشوندها را لاگ و در دور بعدی Discovery به‌روز کنید.
  - برای Institution/PhD Type/Study Mode اگر به توکن‌های دیگری رسیدید، یک نقشهٔ «پیشوند → خانواده» را پویا به‌روزرسانی کنید (مثلاً اگر پیشوند `^i` یا `^p` مشاهده شد، آن را به خانوادهٔ مناسب نسبت دهید و در سند ثبت کنید).

5) پایش تغییرات
   - ممکن است کدها تغییر کنند یا گزینه‌های جدید اضافه شوند. فرایند Discovery را دوره‌ای اجرا و واژه‌نامه‌ها را به‌روزرسانی کنید.

---

## مرتب‌سازی و «Latest only» (در حال اکتشاف)

- در UI گزینه «Latest PhDs only» دیده می‌شود اما پارامتر URL آن در نسخهٔ استاتیک استخراج نشد. دو رویکرد:
  1) ابزار اتوماسیون مرورگر (headless) و شنود تغییر URL هنگام تیک زدن گزینه.
  2) بررسی سورس HTML/JS برای نام پارامتر (مثلاً `SortBy=Date` یا `Latest=1`).
- تا زمان کشف قطعی، می‌توانید نتایج را به‌صورت پیش‌فرض دریافت و در سمت خود با «تاریخ» مرتب کنید؛ ولی دقت کنید که برخی نتایج تاریخ انتشار ندارند یا قالب تاریخ متفاوت است.

راهبرد کشف (Sort/Latest):
- با فعال/غیرفعال کردن «Latest PhDs only» و تغییر گزینهٔ Sort در UI، URL/Network را شنود کنید (DevTools یا headless). معمولاً یکی از این‌ها رخ می‌دهد:
  - پارامتر نام‌دار مثل `SortBy=Date` یا `Latest=1`
  - توکن بی‌نام جدید با پیشوند متفاوت (آن را ثبت کنید).

---

## ناهنجاری‌ها و لبه‌ها (Edge cases)

- مسیر و توکن نامنطبق: گاهی لینک‌های صفحه‌بندی مسیر را به نسخهٔ تک‌فیلتر برمی‌گردانند ولی `PG` و توکن‌ها معتبر می‌مانند. منطق ربات را بر پایهٔ توکن‌ها قرار دهید.
- فیلترهای JS-only: موسسه/نوع برنامه/Latest ممکن است فقط با JS اعمال شوند؛ بنابراین نیازمند Discovery با رندر یا تحلیل JS هستند.
- محدودیت‌ها/کپچا/نرخ درخواست: به robots.txt و TOS احترام بگذارید. نرخ درخواست را محدود و از کش استفاده کنید.
- تغییر کدها در زمان: واژه‌نامه‌ها را نسخه‌بندی کنید و با تست‌های دودکشی (smoke tests) به‌روز‌رسانی را چک کنید.

---

## چک‌لیست پیاده‌سازی ربات

- [ ] ماژول Discovery: خزش صفحات ورودی و استخراج نگاشت کُدها برای هر خانواده.
- [ ] پارسر URL: استخراج `Keywords`, `PG` و دسته‌بندی توکن‌های بی‌نام بر اساس پیشوند.
- [ ] سازنده URL (Builder): دریافت ورودی ساختاریافته و تولید URL مطابق الگوها.
- [ ] صفحه‌بندی: پیمایش `PG=1..N` تا اتمام.
- [ ] مرتب‌سازی/Latest: تلاش برای کشف پارامتر یا مرتب‌سازی سمت کلاینت تا زمان کشف قطعی.
- [ ] مقاومت در برابر تغییر: لاگ‌کردن توکن‌های ناشناخته و افزودن خودکار به صف Discovery.
- [ ] احترام به نرخ و سیاست‌ها: تاخیر بین درخواست‌ها، کش نتایج، و شناسایی خطاهای HTTP/انسداد.

### پوشش فیلترها (وضعیت کنونی)
- [x] Keywords (پارامتر `Keywords`)
- [x] Pagination (`PG`)
- [x] Discipline (`^10...`)
- [x] Subject (`^30...`)
- [x] Geo (`^g...`)
- [x] Funding/Eligibility (`^01...` با گزینه‌های UK/EU/Non‑EU/Self‑funded)
- [ ] Institution (کشف پویا لازم)
- [ ] PhD Type (کشف پویا لازم)
- [ ] Study Mode (کشف پویا لازم)
- [ ] Sort / Latest-only (کشف پویا لازم)

---

## API قراردادی پیشنهادی (برای ماژول URL)

ورودی:
- keywords?: string
- filters?: {
  - disciplineToken?: string
  - subjectToken?: string
  - geoTokens?: string[]
  - fundingTokens?: string[]
  - institutionToken?: string
  - phdTypeToken?: string
}
- page?: number
- pathHints?: { disciplineSlug?: string; countrySlug?: string; subjectSlug?: string }

خروجی:
- url: string (قابل درخواست)

خطاها/اعتبارسنجی:
- در صورت وجود چند توکن متناقض از یک خانواده، هشدار بدهید ولی URL را بسازید (سایت معمولاً آن را به نزدیک‌ترین مجموعه معتبر نگاشت می‌کند).

---

## نمونه‌های تأییدشده

- کلیدواژه:
  - `https://www.findaphd.com/phds/?Keywords=machine%20learning`
- رشته:
  - `https://www.findaphd.com/phds/computer-science/?10M7g0`
- کشور:
  - `https://www.findaphd.com/phds/united-kingdom/?g0w900`
- رشته + کشور:
  - `https://www.findaphd.com/phds/computer-science/united-kingdom/?10M7g0&g0w900`
- فاندینگ (Self-funded) + کلیدواژه:
  - `https://www.findaphd.com/phds/?01M0&Keywords=machine%20learning`
- صفحه‌بندی:
  - `.../phds/computer-science/?10M7g0&PG=2`

---

## اقدامات بعدی پیشنهادی

- افزودن اسکریپت ساده Discovery (Node.js) برای ساخت واژه‌نامهٔ اولیهٔ کدها.
- تلاش برای کشف پارامترهای Sort/Latest با اجرای مرورگر Headless.
- تست واحد برای Parser/Builder بر اساس نمونه‌های بالا.

